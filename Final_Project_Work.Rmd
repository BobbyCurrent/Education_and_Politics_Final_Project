---
title: "Final_Project_Work"
author: "Bobby Current"
date: "11/25/2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(rstanarm)
library(readxl)
library(janitor)
```


```{r relevent data}

presidential_elections <- read_csv("Raw_Data/countypres_2000-2016.csv") %>%
  mutate(vote_prop = (candidatevotes / totalvotes)) %>%
  mutate(percent_won = (vote_prop * 100)) %>%
  filter(party %in% c("democrat", "republican")) %>%
  pivot_wider(id_cols = c(FIPS, year, state),
              names_from = party,
              values_from = c(percent_won, candidate))

spending_2012 <- read_csv("Raw_Data/district_spending_2011.csv", 
                          col_types = cols(name = col_character(),
                                           stname = col_character(),
                                           stabbr = col_character())) %>%
  clean_names() %>%
  select(conum, 
         name, 
         stname, 
         stabbr, 
         totalrev,
         totalexp, 
         tlocrev, 
         tstrev, 
         tfedrev) %>%
  mutate(year = 2012) %>%
  mutate(percent_local = ((tlocrev / totalrev) * 100)) %>%
  mutate(percent_federal = ((tfedrev / totalrev) * 100)) %>%
  mutate(percent_state = ((tstrev / totalrev) * 100))




spending_2008 <- read_csv("Raw_Data/district_spending_2008.csv",
                          col_types = cols(name = col_character(), 
                                           stname = col_character(), 
                                           stabbr = col_character())) %>%
  clean_names() %>%
  select(conum, 
         name, 
         stname, 
         stabbr, 
         totalrev, 
         totalexp, 
         tlocrev,
         tstrev, 
         tfedrev) %>%
  mutate(year = 2008) %>%
  mutate(percent_local = ((tlocrev / totalrev) * 100)) %>%
  mutate(percent_federal = ((tfedrev / totalrev) * 100)) %>%
  mutate(percent_state = ((tstrev / totalrev) * 100))



spending_2004 <- read_csv("Raw_Data/district_spending_2004.csv",
                          col_types = cols(name = col_character(),
                                           stname = col_character(),
                                           stabbr = col_character())) %>%
  clean_names() %>%
  select(conum, 
         name, 
         stname, 
         stabbr, 
         totalrev, 
         totalexp, 
         tlocrev, 
         tstrev, 
         tfedrev) %>%
  mutate(year = 2004) %>%
  mutate(percent_local = ((tlocrev / totalrev) * 100)) %>%
  mutate(percent_federal = ((tfedrev / totalrev) * 100)) %>%
  mutate(percent_state = ((tstrev / totalrev) * 100))
  


spending_2016 <- read_csv("Raw_Data/district_spending_2016.csv", 
                          col_types = cols(name = col_character(),
                                           stname = col_character(),
                                           stabbr = col_character())) %>%
  clean_names() %>%
  select(conum,
         name,
         stname,
         stabbr,
         totalrev,
         totalexp,
         tlocrev,
         tfedrev,
         tstrev) %>%
  mutate(year = 2016) %>%
  mutate(percent_local = ((tlocrev / totalrev) * 100)) %>%
  mutate(percent_federal = ((tfedrev / totalrev) * 100)) %>%
  mutate(percent_state = ((tstrev / totalrev) * 100))



joined_temp <- bind_rows(spending_2004, spending_2008, spending_2012, spending_2016)



spending_2000 <- read_csv("Raw_Data/district_spending_2000.csv",
                          col_types = cols(name = col_character(),
                                           stname = col_character(),
                                           stabbr = col_character())) %>%
  clean_names() %>%
  select(name, 
         stname, 
         stabbr, 
         totalrev, 
         totalexp, 
         tlocrev, 
         tstrev, 
         tfedrev) %>%
  left_join(joined_temp, by = "name") %>%
  filter(!is.na(conum)) %>%
  distinct(conum, .keep_all = TRUE) %>%
  select(name, 
         stname = stname.x, 
         stabbr = stabbr.x, 
         totalrev = totalrev.x, 
         totalexp = totalexp.x, 
         tlocrev = tlocrev.x, 
         tstrev = tstrev.x, 
         tfedrev = tfedrev.x,
         conum) %>%
  mutate(year = 2000) %>%
  mutate(percent_local = ((tlocrev / totalrev) * 100)) %>%
  mutate(percent_federal = ((tfedrev / totalrev) * 100)) %>%
  mutate(percent_state = ((tstrev / totalrev) * 100))


final_data <- bind_rows(joined_temp, spending_2000) %>%
  left_join(presidential_elections, by = c("conum" = "FIPS", "year"))

```





```{r carPlot}

final_data %>%
  #filter(year == 2016) %>%
  #filter(stabbr == "SC") %>%
  ggplot(aes(x = totalexp, y = percent_won_democrat)) +
  geom_point() +
  geom_smooth(method = "lm") +
  scale_x_log10() +
  facet_wrap(~ year) +
  labs(title = "School Spending and Democratic Vote Share in Presidential Elections", 
       subtitle = "Democratic vote share in United States since the 2000 election", 
       x = "Education Spending Per District", 
       y = "Percent of vote for Democratic Candidate")



```

```{r yearPlot}

final_data %>%
  filter(input$years) %>%
  filter(stabbr == input$state) %>%
  ggplot(aes(x = totalexp, y = percent_won_democrat)) +
  geom_point() +
  geom_smooth(method = "lm") +
  scale_x_log10() +
  facet_wrap(~ year) +
  labs(title = "School Spending and Democratic Vote Share in Presidential Elections", 
       subtitle = "2000 to 2016 Presidential Elections", 
       x = "Education Spending Per District", 
       y = "Percent of vote for Democratic Candidate")





```



```{r stan}

final_data_million <- 
  final_data %>%
  mutate(totalexp_mil = (totalexp / 1000000)) %>%
  mutate(totalrev_mil = (totalrev / 1000000)) %>%
  mutate(stname = toupper(stname))

data_stan <- stan_glm(data = final_data_million,
         formula = percent_won_democrat ~ per_capita_rev,
         refresh = 0)

print(data_stan, digits = 7)



```




